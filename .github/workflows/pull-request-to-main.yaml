name: Pull Request to Main
# On a pull request make sure terraform is formatted and valid.

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
    branches:
      - main
  workflow_dispatch:

jobs:
  check_terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Validate Terraform
        run: |
          cd terraform
          terraform init -backend=false
          terraform fmt -recursive -diff -check
          
          for module in ./aws
          do
            cd ${module}
            terraform init -backend=false
            terraform validate
            cd -
          done
          
          for module in ./modules
          do
            cd ${module}
            terraform init -backend=false
            terraform validate
            cd -
          done
          
          terraform validate
  
  deploy_to_observability_dev:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: 
        - check_terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Assume AWS Role
        # 468565409170
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DT_GH_ACTIONS_NON_PROD_ROLE_ARN }}
          aws-region: eu-west-2
          role-duration-seconds: 1800
      - name: Generate Terraform Config
        run: |
          cd terraform
          cat << EOF > terraform.auto.tfvars
          name = ["di", "observability", "dev"]
          tags = {
            Product : "GOV.UK Sign In"
            System : "Observability"
            Environment : "development"
            Owner : "${{ secrets.OBSERVABILITY_TEAM_EMAIL }}"
            Source : "https://github.com/govuk-one-login/observability-infrastructure"
          }
          EOF
          sed -i 's/bucket         = ""/bucket         = "${{ secrets.OBSERVABILITY_DEV_TERRAFORM_STATE_BUCKET }}"/g' site.tf
      - name: Apply To Dev
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve
