name: Back Up the Dynatrace Dashboards (JSON files) to S3

on: 
    schedule:
    # Run at 15:04 on a Friday
    # 04 minutes past to avoid the on the hour surge in demand
    - cron: "04 15 * * 5"

permissions:
  id-token: write
  contents: read

jobs:
  backup_non_prod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Assume AWS Role
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DT_GH_ACTIONS_NON_PROD_ROLE_ARN }}
          aws-region: eu-west-2
      - name: Run backup script and Backup dashboards
        run: |
          ./scripts/dashboard_backup.sh
        env:
          ENVIRONMENT: ${{ secrets.DT_NON_PROD_ENVIRONMENT }}
          API_TOKEN: ${{ secrets.DT_NON_PROD_API_TOKEN }}
      - name: Upload Dashboads to S3 bucket
        run: |
          aws s3 sync ./*_backup_dashboard s3://${{ secrets.DT_DASHBOARDS_NON_PROD_BUCKET_NAME }}/$(date '+%Y-%m-%d')/
          rm -rf ./*_backup_dashboard
  
  backup_prod:
    runs-on: ubuntu-latest
    needs:
      - backup_non_prod
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Assume AWS Role
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DT_GH_ACTIONS_PROD_ROLE_ARN }}
          aws-region: eu-west-2
      - name: Run backup script and Backup dashboards
        run: |
          ./scripts/dashboard_backup.sh
        env:
          ENVIRONMENT: ${{ secrets.DT_PROD_ENVIRONMENT }}
          API_TOKEN: ${{ secrets.DT_PROD_API_TOKEN }}
      - name: Upload Dashboads to S3 bucket
        run: |
          aws s3 sync ./*_backup_dashboard s3://${{ secrets.DT_DASHBOARDS_PROD_BUCKET_NAME }}/$(date '+%Y-%m-%d')/
          rm -rf ./*_backup_dashboard